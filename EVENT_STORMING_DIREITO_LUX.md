# Event Storming - Direito Lux

## Workshop Overview
**Objetivo**: Mapear o domÃ­nio do Direito Lux e identificar bounded contexts, agregados e eventos

**Participantes**: Product Owner, Tech Lead, Stakeholders jurÃ­dicos

**DuraÃ§Ã£o**: 4-6 horas (pode ser dividido em 2 sessÃµes)

## ðŸŸ  Domain Events (Eventos de DomÃ­nio)

### Cliente/User Journey
```
ðŸŸ  UserRegistered
ðŸŸ  UserActivated  
ðŸŸ  UserLoggedIn
ðŸŸ  UserSubscriptionChanged
ðŸŸ  UserDeactivated
```

### Processo JurÃ­dico Lifecycle
```
ðŸŸ  ProcessRequested          // Cliente solicita monitoramento
ðŸŸ  ProcessValidated          // NÃºmero do processo validado
ðŸŸ  ProcessRegistered         // Processo cadastrado no sistema
ðŸŸ  ProcessMonitoringStarted  // Monitoramento ativo iniciado
ðŸŸ  ProcessDataFetched        // Dados obtidos do DataJud
ðŸŸ  ProcessUpdated            // Nova movimentaÃ§Ã£o detectada
ðŸŸ  ProcessMovementDetected   // EspecÃ­fico para movimentaÃ§Ãµes
ðŸŸ  ProcessDeadlineDetected   // Prazo identificado
ðŸŸ  ProcessStatusChanged      // MudanÃ§a de status processual
ðŸŸ  ProcessConcluded          // Processo finalizado
ðŸŸ  ProcessMonitoringStopped  // Monitoramento pausado/parado
ðŸŸ  ProcessArchived           // Processo arquivado
```

### NotificaÃ§Ãµes
```
ðŸŸ  NotificationRequested     // Sistema solicita envio
ðŸŸ  NotificationScheduled     // Agendada para envio
ðŸŸ  NotificationSent          // Enviada com sucesso
ðŸŸ  NotificationFailed        // Falha no envio
ðŸŸ  NotificationDelivered     // ConfirmaÃ§Ã£o de entrega
ðŸŸ  NotificationRead          // Lida pelo destinatÃ¡rio
ðŸŸ  NotificationRetryScheduled // Reagendada para retry
```

### IntegraÃ§Ã£o DataJud
```
ðŸŸ  DataJudQueryRequested     // Consulta solicitada
ðŸŸ  DataJudQueryExecuted      // Consulta executada
ðŸŸ  DataJudDataReceived       // Dados recebidos
ðŸŸ  DataJudRateLimitReached   // Limite atingido
ðŸŸ  DataJudErrorOccurred      // Erro na consulta
ðŸŸ  DataJudCacheHit           // Cache utilizado
ðŸŸ  DataJudCacheMiss          // Cache miss
```

### Tenant Management
```
ðŸŸ  TenantCreated            // Novo escritÃ³rio cadastrado
ðŸŸ  TenantActivated          // EscritÃ³rio ativado
ðŸŸ  TenantQuotaUpdated       // Cota alterada
ðŸŸ  TenantQuotaExceeded      // Cota excedida
ðŸŸ  TenantBillingCycleStarted // Novo ciclo de cobranÃ§a
ðŸŸ  TenantSuspended          // EscritÃ³rio suspenso
ðŸŸ  TenantReactivated        // EscritÃ³rio reativado
```

### InteligÃªncia Artificial
```
ðŸŸ  AISummarizationRequested  // Resumo solicitado
ðŸŸ  AISummaryGenerated        // Resumo gerado
ðŸŸ  AITermExplanationRequested // ExplicaÃ§Ã£o solicitada
ðŸŸ  AITermExplained           // Termo explicado
ðŸŸ  AIAnalysisCompleted       // AnÃ¡lise concluÃ­da
ðŸŸ  AIModelTrainingStarted    // Treinamento iniciado
```

### Documentos
```
ðŸŸ  DocumentGenerationRequested // GeraÃ§Ã£o solicitada
ðŸŸ  DocumentGenerated           // Documento gerado
ðŸŸ  DocumentSigned              // Documento assinado
ðŸŸ  DocumentSent                // Documento enviado
ðŸŸ  DocumentArchived            // Documento arquivado
```

## ðŸ”µ Commands (Comandos)

### User Commands
```
ðŸ”µ RegisterUser
ðŸ”µ ActivateUser
ðŸ”µ LoginUser
ðŸ”µ ChangeUserSubscription
ðŸ”µ DeactivateUser
```

### Process Commands
```
ðŸ”µ RequestProcessMonitoring
ðŸ”µ ValidateProcessNumber
ðŸ”µ RegisterProcess
ðŸ”µ StartMonitoring
ðŸ”µ StopMonitoring
ðŸ”µ UpdateProcessData
ðŸ”µ ArchiveProcess
ðŸ”µ SetProcessDeadline
```

### Notification Commands
```
ðŸ”µ SendNotification
ðŸ”µ ScheduleNotification
ðŸ”µ RetryNotification
ðŸ”µ CancelNotification
ðŸ”µ UpdateNotificationTemplate
```

### DataJud Commands
```
ðŸ”µ QueryDataJud
ðŸ”µ FetchProcessData
ðŸ”µ RefreshCache
ðŸ”µ UpdateRateLimit
```

### AI Commands
```
ðŸ”µ SummarizeProcess
ðŸ”µ ExplainLegalTerm
ðŸ”µ AnalyzeDocument
ðŸ”µ TrainModel
```

## ðŸŸ¡ Aggregates (Agregados)

### 1. User Aggregate
```go
type User struct {
    ID           UserID
    Email        string
    TenantID     TenantID
    Role         UserRole
    Subscription SubscriptionType
    Status       UserStatus
    CreatedAt    time.Time
    LastLoginAt  time.Time
}
```

### 2. Process Aggregate
```go
type Process struct {
    ID              ProcessID
    Number          ProcessNumber
    TenantID        TenantID
    ClientID        ClientID
    Court           Court
    Status          ProcessStatus
    MonitoringState MonitoringState
    Movements       []ProcessMovement
    Deadlines       []Deadline
    CreatedAt       time.Time
    LastUpdatedAt   time.Time
}
```

### 3. Notification Aggregate
```go
type Notification struct {
    ID          NotificationID
    TenantID    TenantID
    ProcessID   ProcessID
    RecipientID UserID
    Channel     NotificationChannel
    Template    MessageTemplate
    Status      NotificationStatus
    Attempts    int
    CreatedAt   time.Time
    SentAt      *time.Time
}
```

### 4. Tenant Aggregate
```go
type Tenant struct {
    ID           TenantID
    Name         string
    Subscription SubscriptionPlan
    Quotas       TenantQuotas
    Status       TenantStatus
    BillingInfo  BillingInfo
    CreatedAt    time.Time
}
```

### 5. DataJudQuery Aggregate
```go
type DataJudQuery struct {
    ID           QueryID
    TenantID     TenantID
    ProcessNumber ProcessNumber
    QueryType    QueryType
    Status       QueryStatus
    RateLimit    RateLimit
    CacheStatus  CacheStatus
    ExecutedAt   time.Time
}
```

## ðŸŸ¢ Views/Read Models (ProjeÃ§Ãµes)

### Process Dashboard View
```go
type ProcessDashboardView struct {
    TenantID        TenantID
    TotalProcesses  int
    ActiveProcesses int
    RecentUpdates   []ProcessUpdate
    PendingDeadlines []Deadline
    QuotaUsage      QuotaUsage
}
```

### Notification History View
```go
type NotificationHistoryView struct {
    TenantID         TenantID
    TotalSent        int
    DeliveryRate     float64
    FailedByChannel  map[Channel]int
    RecentFailures   []FailedNotification
}
```

### Analytics View
```go
type TenantAnalyticsView struct {
    TenantID           TenantID
    ProcessesPerMonth  map[string]int
    NotificationsPerDay map[string]int
    TopClients         []ClientStats
    ApiUsage           ApiUsageStats
}
```

## ðŸ”´ Bounded Contexts

### 1. Authentication & Authorization Context
**Responsabilidade**: GestÃ£o de usuÃ¡rios, autenticaÃ§Ã£o e autorizaÃ§Ã£o
```
Aggregates: User, Role, Permission
Events: UserRegistered, UserLoggedIn, RoleAssigned
Services: AuthService, PermissionService
```

### 2. Tenant Management Context  
**Responsabilidade**: GestÃ£o de tenants, quotas e billing
```
Aggregates: Tenant, Subscription, Quota
Events: TenantCreated, QuotaExceeded, BillingCycleStarted
Services: TenantService, QuotaService, BillingService
```

### 3. Process Management Context
**Responsabilidade**: GestÃ£o do ciclo de vida dos processos
```
Aggregates: Process, ProcessMovement, Deadline
Events: ProcessRegistered, ProcessUpdated, DeadlineDetected
Services: ProcessService, MonitoringService
```

### 4. External Integration Context (DataJud)
**Responsabilidade**: IntegraÃ§Ã£o com APIs externas
```
Aggregates: DataJudQuery, Cache, RateLimit
Events: DataJudQueryExecuted, CacheHit, RateLimitReached
Services: DataJudService, CacheService, RateLimitService
```

### 5. Notification Context
**Responsabilidade**: OrquestraÃ§Ã£o e envio de notificaÃ§Ãµes
```
Aggregates: Notification, NotificationTemplate, Channel
Events: NotificationSent, NotificationFailed, NotificationDelivered
Services: NotificationService, WhatsAppService, EmailService
```

### 6. AI & Analytics Context
**Responsabilidade**: InteligÃªncia artificial e anÃ¡lises
```
Aggregates: AISummary, AnalysisResult, Model
Events: SummaryGenerated, AnalysisCompleted, ModelTrained
Services: AIService, SummarizationService, AnalyticsService
```

### 7. Document Management Context
**Responsabilidade**: GeraÃ§Ã£o e gestÃ£o de documentos
```
Aggregates: Document, Template, Signature
Events: DocumentGenerated, DocumentSigned, DocumentArchived
Services: DocumentService, TemplateService, SignatureService
```

## ðŸ”€ Context Map

```
[Authentication] --> [Tenant Management] : User belongs to Tenant
[Tenant Management] --> [Process Management] : Tenant owns Processes
[Process Management] --> [External Integration] : Process data from DataJud
[Process Management] --> [Notification] : Process changes trigger notifications
[Process Management] --> [AI & Analytics] : Process data for AI analysis
[Notification] --> [Authentication] : User preferences for notifications
[AI & Analytics] --> [Document Management] : AI generates documents
[Tenant Management] --> [All Contexts] : Quota enforcement
```

## ðŸ“‹ Saga Patterns Identificados

### 1. Process Registration Saga
```
1. ValidateProcessNumber
2. CheckTenantQuota
3. RegisterProcess
4. StartMonitoring
5. SendConfirmationNotification

Compensations:
- RemoveProcess if monitoring fails
- RestoreQuota if process invalid
```

### 2. Notification Delivery Saga
```
1. PrepareNotification
2. SelectChannel (WhatsApp -> Email -> SMS)
3. SendNotification
4. ConfirmDelivery
5. UpdateStatistics

Compensations:
- Retry with different channel
- Mark as failed after max attempts
```

### 3. Tenant Onboarding Saga
```
1. CreateTenant
2. SetupDefaultQuotas
3. CreateAdminUser
4. SendWelcomeNotification
5. ActivateTenant

Compensations:
- Cleanup if any step fails
- Rollback tenant creation
```

## ðŸŽ¯ Key Insights do Event Storming

### 1. Bounded Contexts bem definidos
- **Authentication**: Isolado e reutilizÃ¡vel
- **Process Management**: Core domain 
- **Notification**: Complex orchestration needed
- **AI**: Separate context for ML concerns

### 2. Critical Integration Points
- **DataJud API**: Rate limiting critical
- **WhatsApp Business**: Primary channel
- **Multi-tenant**: Isolation everywhere

### 3. Event-driven Opportunities
- **Process monitoring**: Event-sourcing ideal
- **Notifications**: Pub/Sub pattern
- **Analytics**: Event streaming for real-time

### 4. Consistency Boundaries
- **Strong consistency**: Within aggregates
- **Eventual consistency**: Between contexts
- **Sagas**: For cross-context transactions

## ðŸ“– Ubiquitous Language

### Core Terms
- **Processo**: Processo jurÃ­dico a ser monitorado
- **MovimentaÃ§Ã£o**: AtualizaÃ§Ã£o/mudanÃ§a no processo
- **Prazo**: Data limite para aÃ§Ã£o processual
- **Tenant**: EscritÃ³rio de advocacia (inquilino)
- **Monitoramento**: VerificaÃ§Ã£o automÃ¡tica de mudanÃ§as
- **NotificaÃ§Ã£o**: ComunicaÃ§Ã£o enviada ao usuÃ¡rio
- **Quota**: Limite de uso por tenant
- **DataJud**: API oficial do CNJ para dados processuais

### Domain-specific Terms
- **NÃºmero CNJ**: Identificador Ãºnico nacional do processo
- **Tribunal**: Ã“rgÃ£o julgador (TJ, TRF, etc.)
- **Grau**: InstÃ¢ncia processual (1Âº, 2Âº grau)
- **Classe**: Tipo de aÃ§Ã£o judicial
- **Assunto**: MatÃ©ria jurÃ­dica do processo

## ðŸ”§ Technical Decisions from Event Storming

### 1. Event Store Strategy
- **Process Context**: Full event sourcing
- **Other Contexts**: Event-driven with projections
- **Snapshots**: Every 50 events for performance

### 2. Consistency Strategy
- **Command side**: Strong consistency
- **Query side**: Eventual consistency acceptable
- **SLA**: 5 seconds max for notifications

### 3. Data Partitioning
- **Tenant-based**: All data partitioned by TenantID
- **Time-based**: Events partitioned by month
- **Geographic**: Future multi-region consideration

### 4. Integration Patterns
- **DataJud**: Publish-subscribe with cache
- **WhatsApp**: Request-response with retry
- **Internal**: Event-driven with message bus